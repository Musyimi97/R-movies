"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }var _fs = require('fs'); var _fs2 = _interopRequireDefault(_fs);var _globby = require('globby'); var _globby2 = _interopRequireDefault(_globby);var _handlebars = require('handlebars'); var _handlebars2 = _interopRequireDefault(_handlebars);var _isutf8 = require('is-utf8'); var _isutf82 = _interopRequireDefault(_isutf8);var _path = require('path'); var _path2 = _interopRequireDefault(_path);var _slash = require('slash'); var _slash2 = _interopRequireDefault(_slash);var _uuid = require('uuid');function L(e){return e.split(/[-_\s]+/)}function M(e){return L(m(e)).join(" ")}_handlebars2.default.registerHelper("space",M);function m(e){return e.replace(/[\r\n]/g,"")}_handlebars2.default.registerHelper("trim",m);function q(e){return m(e).toUpperCase()}_handlebars2.default.registerHelper("upper",q);function J(e,t){const i=t&&t.hash&&t.hash.space;return m(e).toLowerCase()}_handlebars2.default.registerHelper("lower",J);function O(e,t){const i=t&&t.hash&&t.hash.space;return L(m(e)).map(a=>a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()).join(i?" ":"")}_handlebars2.default.registerHelper("capital",O);function K(e){return O(e).replace(/^./,t=>t.toLowerCase())}_handlebars2.default.registerHelper("camel",K);function N(e){return O(e).replace(/(?<=([a-z](?=[A-Z])|[A-Za-z](?=[0-9])))(?=[A-Z0-9])/g,"_").toLowerCase()}_handlebars2.default.registerHelper("snake",N);function Q(e){return N(e).replace(/_/g,"-")}_handlebars2.default.registerHelper("kebab",Q);function X(){return _uuid.v4.call(void 0, )}_handlebars2.default.registerHelper("uuid",X);function A(e,t){const i=_handlebars2.default.compile(e.toString(),{noEscape:!0});return i(t)}function ee(e){try{const t=_path2.default.dirname(e);_fs2.default.mkdirSync(t,{recursive:!0})}catch(t){}}function $(e){return _fs2.default.readdirSync(e).filter(t=>!t.startsWith("."))}async function I(e){const t=await _globby2.default.call(void 0, _slash2.default.call(void 0, e.templateDir),{dot:!0});for(const i of t){const a=_path2.default.relative(e.templateDir,i),s=A(_path2.default.resolve(e.packageDir,a),e.view);ee(s);let n=_fs2.default.readFileSync(i),o=n;_isutf82.default.call(void 0, n)&&(o=Buffer.from(A(n,e.view))),_fs2.default.writeFileSync(s,o,"utf-8")}}var _chalk = require('chalk'); var _chalk2 = _interopRequireDefault(_chalk);var _crossspawn = require('cross-spawn');var _epicfail = require('epicfail'); var _epicfail2 = _interopRequireDefault(_epicfail);var _execa = require('execa'); var _execa2 = _interopRequireDefault(_execa);var _gitconfig = require('gitconfig'); var _gitconfig2 = _interopRequireDefault(_gitconfig);var _licensejs = require('license.js');var _yargsinteractive = require('yargs-interactive'); var _yargsinteractive2 = _interopRequireDefault(_yargsinteractive);class w extends Error{constructor(e){super(e);this.name="CLIError"}}async function se(){try{const e=await _gitconfig2.default.get({location:"global"});return e.user}catch(e){return{}}}function oe(e,t=[],i={}){return new Promise((a,s)=>{const n=_crossspawn.spawn.call(void 0, e,t,{stdio:"inherit",...i});n.on("close",o=>{if(o!==0)return s(o);a(o)})})}async function ce(e,t){let i,a;t?(i="yarnpkg",a=["install","--cwd",e]):(i="npm",a=["install"],process.chdir(e));try{await oe(i,a,{stdio:"inherit"})}catch(s){throw new w(`installDeps failed: ${s}`)}}async function le(){try{return await _execa2.default.call(void 0, "yarnpkg",["--version"]),!0}catch(e){return!1}}function pe(e,t){return _fs2.default.existsSync(_path2.default.resolve(t,e))}async function me(e){await _execa2.default.call(void 0, "git init",{shell:!0,cwd:e})}function j(e,t){return`${e}${t?` <${t}>`:""}`}function ge(e){try{return _fs2.default.readdirSync(e).filter(t=>!t.startsWith(".")).length!==0}catch(t){if(t.code==="ENOENT")return!1;throw t}}async function fe(e,t,i={}){const a=await se(),s=$(e),n=s.length>1,o=n&&t,v={interactive:{default:!0},description:{type:"input",describe:"description",default:"description",prompt:"if-no-arg"},author:{type:"input",describe:"author name",default:a.name,prompt:"if-no-arg"},email:{type:"input",describe:"author email",default:a.email,prompt:"if-no-arg"},template:{type:"list",describe:"template",default:"default",prompt:o?"if-no-arg":"never",choices:s},license:{type:"list",describe:"license",choices:[..._licensejs.availableLicenses.call(void 0, ),"UNLICENSED"],prompt:"if-no-arg"},...i};return v}async function Fe(e,t){_epicfail2.default.call(void 0, {assertExpected:r=>r.name==="CLIError"});const i=process.argv[2];if(i===void 0)throw new w(`${e} <name>`);const a=i===".",s=a?_path2.default.basename(process.cwd()):t.modifyName?await Promise.resolve(t.modifyName(i)):i,n=a?process.cwd():_path2.default.resolve(s),{templateRoot:o,promptForTemplate:v=!1}=t;if(ge(n))throw new w(`${n} is not empty directory.`);const U=await fe(o,v,t.extra),l=await _yargsinteractive2.default.call(void 0, ).usage("$0 <name> [args]").interactive(U),D=l.template,b=_path2.default.resolve(o,D),k=new Date().getFullYear(),P=j(l.author,l.email);if(!_fs2.default.existsSync(b))throw new w("No template found");const E=Object.entries(l).filter(r=>r[0].match(/^[^$_]/)&&!["interactive","template"].includes(r[0])).reduce((r,p)=>(r[p[0]]=p[1],r),{}),V={...E,name:s,year:k,contact:P};console.log(`
Creating a new package in ${_chalk2.default.green(n)}.
`),await I({packageDir:n,templateDir:b,view:V});try{const r=_licensejs.makeLicenseSync.call(void 0, l.license,{year:k,project:s,description:l.description,organization:j(l.author,l.email)}),p=r.header+r.text+r.warranty;_fs2.default.writeFileSync(_path2.default.resolve(n,"LICENSE"),p)}catch(r){}const S=await le();pe("package.json",n)&&(console.log("Installing dependencies."),await ce(n,S));try{await me(n),console.log(`
Initialized a git repository`)}catch(r){if(r.exitCode==127)return;throw r}const _=(r,p={})=>{const f=r.split(" ");return _execa2.default.call(void 0, f[0],f.slice(1),{stdio:"inherit",cwd:n,...p})},z=r=>new Promise((p,f)=>{let u,d;S?(u="yarnpkg",d=["--cwd",n,"add",r]):(u="npm",d=["install","-D",r],process.chdir(n));const Y=_crossspawn.spawn.call(void 0, u,d,{stdio:"inherit"});Y.on("close",Z=>{if(Z!==0)return f(`installDeps failed: ${u} ${d.join(" ")}`);p()})}),H={name:s,packageDir:n,template:D,templateDir:b,year:k,run:_,installNpmPackage:z,answers:{...E,contact:P}};if(t.after&&await Promise.resolve(t.after(H)),console.log(`
Success! Created ${_chalk2.default.bold.cyan(s)}.`),t.caveat)switch(typeof t.caveat){case"string":console.log(t.caveat);break;case"function":const r=await Promise.resolve(t.caveat(H));r&&console.log(r);break;default:}}exports.a = w; exports.b = Fe;
